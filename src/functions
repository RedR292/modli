##Installs a mod to the modli system. 
##DOES NOT ADD MOD TO A STAGE FILE
install(){
	if [[ -z "$MOD" ]]; then
		echo "Enter the mod's directory (filepath): "
		read MOD
	fi
	if [[ -z "$MOD" ]]; then
		echo "modli: ERR: NO MOD PASSED. ABORTING INSTALLATION" >&2
		return 1
	fi
	##User input to rename mod
	echo "modli: Installing $(basename "$MOD") to modli."
	echo "Rename the file and press enter. Raw mods must end in .7z and install scripts must end in .sh."
	echo "Leave this blank if you don't want to change the name."
	read mod
	##User didn't rename the mod
	if [[ -z "$mod" ]]; then
		mod="$(basename "$MOD")"
	fi
	##Allows for implicit extension naming of MOD
	if [[ "${mod##*.}" != 7z ]]; then
		mod="$mod.7z"
	fi

	##Installing a mod
	if [[ "$mod" == *.7z ]]; then
		if [[ -f "$root/Games/$GAME_NAME/Mods/$mod" ]]; then
			echo "modli: $mod was already installed. Aborting install"
			return 0
		fi
		##Check if MOD can be installed directly or if it requires a script
		checkTrivialMod			
		if [ $? -eq 1 ]; then
			return 1
		fi

		validatemod
		status=$?
		if [ $status -eq 1 ]; then
			echo "modli: ERR: $(basename "$MOD") IS NOT A 7z ARCHIVE." >&2
                        return 1

		elif [ $status -eq 2 ]; then
			echo "modli: ERR: $(basename "$MOD") HAS MORE THAN ONE ROOT DIRECTORY" >&2
			return 1

		elif [ $status -eq 3 ]; then
                        echo "modli: ERR: $(basename "$MOD")'s ROOT DIRECTORY NOT NAMED 'Data'" >&2
                        return 1
		fi
		
		mv "$MOD" "$root/Games/$GAME_NAME/Mods/$mod"

	##Installing a script
	elif [[ "$mod" == *.sh ]]; then
		if [[ -d "$root/Games/$GAME_NAME/Scripts/${mod%.*}" ]]; then
			echo "modli: $mod already exists. Aborting installation"
			return 0
		fi
		mkdir "$root/Games/$GAME_NAME/Scripts/${mod%.*}"
		mv "$MOD" "$root/Games/$GAME_NAME/Scripts/${mod%.*}/"
		echo Enter the directory of the mod and/or data to go with the script. If no data is needed, press enter to skip.
		echo WARNING: scripts are not validated by modli. Best practices are recommended when writing your own scripts
		echo Proceeding means the user understands the risks of a poorly written script, such as corrupted, missing and/or unchecked data. 
		read datadir
		if [[ ! -z "$datadir" ]]; then
			mv "$datadir"/* "$root/Games/$GAME_NAME/Scripts/${mod%.*}/"
		fi
	else
		echo "modli: ERR: $(basename "$mod") must end in .7z or .sh. Aborting installation" >&2
		return 1
	fi
	echo "modli: $mod was successfully installed"
	return 0
}

##Removes a mod from modli
##Could break a lot of stuff if not done right.
##TODO: Remove mods from games. Detect if the stage file is launched?
uninstall(){
	ls -p "$root/Games/$GAME_NAME/Mods" | grep -v /
	echo Enter the name of the mod you would like to remove: 
	read mod
	if [[ ! -f "$root/Games/$GAME_NAME/Mods/$mod" ]]; then
		echo modli: ERR: $mod not found >&2
		return 1
	fi
	rm "$root/Games/$GAME_NAME/Mods/$mod"
	echo "modli: $mod was succsessfully uninstalled"
	return 0
}

##executes a custom install script
installScript(){
	. "$root/Games/$GAME_NAME/Scripts/$MOD"
	if [[ $? -ne 0 ]]; then
		echo "modli: ERR: $MOD was not executed properly" >&2
		return 1
	fi
	echo "modli: $MOD succsessfully executed"
	return 0
}

##Adds $MOD to $GAME_NAME stage file
addToStage(){
	ls -p "$root/Games/$GAME_NAME/Mods" | grep -v /
	echo "Enter the name of the mod you would like to add to $GAME's stage file"
	read mod

	##If mod was not found
	if [[ ! -f "$root/Games/$GAME_NAME/Mods/$mod" ]]; then
		echo "modli: ERR: $mod not found" >&2
		return 1
	fi
	
	##If mod already exists in stage
	if [[ -L "$root/Games/$GAME_NAME/stage/$mod" ]]; then
		echo "modli: $mod is already in $GAME_NAME's stage"
		return 0
	fi
 	#Creates a symbolic link to avoid duplicating files
	ln -s "$root/Games/$GAME_NAME/Mods/$mod" "$root/Games/$GAME_NAME/stage/$mod"
	echo "modli: $mod was added to $GAME_NAME's stage"
	return 0
}

##Removes a mod from GAMEs stage file
removeFromStage(){
	ls -p "$root/Games/$GAME_NAME/stage" | grep -v / 
	echo Enter the name of the mod you want to remove from the list: 
	read mod
	if [ ! -f "$root/Games/$GAME_NAME/stage/$mod" ]; then
		echo "modli: ERR: $mod was not found" >&2
		return 1
	fi
	rm "$root/Games/$GAME_NAME/stage/$mod"
	echo "$mod was removed from $GAME_NAME's stage file"
	return 0
}

##launches stage file to GAME
##This performs the BARE MINIMUM and needs to be implemented into each mod manager
Launch(){
	echo "Preparing to implement stage file to $GAME_NAME"
	mkdir "$root/tmp"
	for file in "$root/Games/$GAME_NAME/stage"/*; do	
		7z x "$file" -o"$root/tmp/"
		cp -r "$root/tmp/Data" "$GAMEPATH/"
		rm -dR "$GAMEPATH/tmp/Data"
		echo "modli: installed $(basename "$file") to $GAME_NAME"
	done
	rm -dR "$root/tmp"
	echo "modli: Stage file has been launched to $GAME_NAME"
	return 0
}

##Checks all available mods for GAME
checkAvailableMods(){
	echo "Mods available to be installed to $GAME_NAME:"
	for mod in "$root/Games/$GAME_NAME/Mods"/*; do
		mod="$(basename "$mod")"
		##Print only mods that aren't already in the stage file
		if [[ ! -L "$root/Games/$GAME_NAME/stage/$mod" ]]; then 
			echo "$mod"
		fi
	done
}

##Checks all currently installed mods for GAME
checkInstalledMods(){
	echo "Mods currently installed to $GAME_NAME:" 
	for mod in "$root/Games/$GAME_NAME/stage"/*; do
		echo "$(basename "$mod")"
	done
}
